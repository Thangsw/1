<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Whisk Multi-Acc Proxy Test (Index 4)</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #f3f4f6;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      padding: 14px 18px;
      border-radius: 10px;
      margin-bottom: 16px;
    }
    .header h1 {
      margin: 0 0 4px;
      font-size: 1.4rem;
    }
    .header p {
      margin: 0;
      font-size: 0.9rem;
      opacity: 0.9;
    }
    .grid {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 16px;
    }
    .card {
      background: #fff;
      border-radius: 10px;
      padding: 14px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    }
    h2 {
      font-size: 1rem;
      margin: 0 0 10px;
      color: #4f46e5;
    }
    .input-group {
      margin-bottom: 10px;
    }
    .input-group label {
      font-size: 0.85rem;
      font-weight: 600;
      display: block;
      margin-bottom: 4px;
      color: #374151;
    }
    input, textarea, select {
      width: 100%;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-size: 0.85rem;
      box-sizing: border-box;
    }
    textarea {
      min-height: 80px;
      resize: vertical;
      font-family: 'Courier New', monospace;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 6px 10px;
      border-radius: 6px;
      border: none;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      background: #4f46e5;
      color: #fff;
      margin-right: 6px;
      margin-bottom: 6px;
    }
    .btn.secondary {
      background: #6b7280;
    }
    .btn.small {
      font-size: 0.8rem;
      padding: 4px 8px;
    }
    .token-pool-list {
      max-height: 180px;
      overflow-y: auto;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      padding: 6px;
      font-size: 0.8rem;
      background: #f9fafb;
    }
    .token-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 3px 2px;
      gap: 6px;
    }
    .token-item label {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }
    .token-proxy-tag {
      font-size: 0.7rem;
      padding: 1px 6px;
      border-radius: 999px;
      background: #e0f2fe;
      color: #0369a1;
      white-space: nowrap;
    }
    .badge {
      display: inline-block;
      padding: 1px 6px;
      border-radius: 999px;
      font-size: 0.7rem;
      background: #eef2ff;
      color: #4338ca;
      margin-left: 4px;
    }
    .status-line {
      font-size: 0.8rem;
      color: #4b5563;
      margin-top: 4px;
    }
    .results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }
    .result-item {
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      overflow: hidden;
      background: #fff;
      font-size: 0.8rem;
    }
    .result-item img {
      width: 100%;
      height: 120px;
      object-fit: cover;
      display: block;
    }
    .result-body {
      padding: 6px 8px;
    }
    .result-body .idx {
      font-weight: 600;
      color: #4f46e5;
      margin-bottom: 2px;
    }
    .log {
      font-family: 'Courier New', monospace;
      font-size: 0.8rem;
      background: #111827;
      color: #e5e7eb;
      border-radius: 8px;
      padding: 8px;
      max-height: 260px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    .log-line.info { color: #a5b4fc; }
    .log-line.success { color: #6ee7b7; }
    .log-line.error { color: #fca5a5; }
    .log-line.warn { color: #fde68a; }
    @media (max-width: 900px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Index 4 - Test Multi Acc + Proxy (Whisk Image)</h1>
      <p>Ch·ªçn nhi·ªÅu token (m·ªói token = 1 acc + proxy) ‚Üí Load Token Pool ‚Üí b·∫Øn nhanh prompts ƒë·ªÉ xem mediaID + ·∫£nh.</p>
    </div>

    <div class="grid">
      <!-- LEFT: TOKEN POOL + TEST SETTINGS -->
      <div class="card">
        <h2>‚ö° Token Pool (Multi Acc + Proxy)</h2>
        <div class="input-group">
          <label>Danh s√°ch token (t·ª´ tokens.txt)</label>
          <div id="tokenPoolStatus" class="status-line">ƒêang load...</div>
        </div>
        <div id="tokenList" class="token-pool-list">
          <div style="font-size:0.8rem;color:#6b7280;">ƒêang ƒë·ªçc file tokens.txt...</div>
        </div>
        <div style="margin-top:8px;">
          <button class="btn" onclick="loadTokenPool()">‚ö° Load Token Pool</button>
          <button class="btn secondary small" onclick="refreshTokenList()">üîÑ Refresh</button>
        </div>
        <div class="status-line">
          <strong>L∆∞u √Ω:</strong> server s·∫Ω round-robin qua token pool khi g·ªçi <code>/api/generate</code> ‚Üí m·ªói request d√πng acc + proxy kh√°c nhau.
        </div>

        <hr style="margin:12px 0;border:none;border-top:1px solid #e5e7eb;" />

        <h2>üß™ Prompt Test Nhanh</h2>
        <div class="input-group">
          <label>Prompts test (m·ªói d√≤ng 1 prompt)</label>
          <textarea id="testPrompts" placeholder="1. Simple test prompt 1
2. Simple test prompt 2
3. Simple test prompt 3"></textarea>
        </div>
        <div class="input-group">
          <label>Aspect ratio</label>
          <select id="testAspect">
            <option value="IMAGE_ASPECT_RATIO_LANDSCAPE">Landscape (16:9)</option>
            <option value="IMAGE_ASPECT_RATIO_PORTRAIT">Portrait (9:16)</option>
            <option value="IMAGE_ASPECT_RATIO_SQUARE">Square (1:1)</option>
          </select>
        </div>
        <div class="input-group">
          <label>Common suffix (tu·ª≥ ch·ªçn, s·∫Ω g·∫Øn sau m·ªçi prompt)</label>
          <textarea id="testCommon" rows="2" placeholder="V√≠ d·ª•: anime style, vibrant colors, for kids"></textarea>
        </div>
        <div style="margin-top:4px;">
          <button class="btn" onclick="runBurstTest()">üöÄ Gen ·∫£nh (multi acc + proxy)</button>
        </div>
        <div class="status-line" id="burstStatus">Ch∆∞a ch·∫°y test.</div>

        <hr style="margin:12px 0;border:none;border-top:1px solid #e5e7eb;" />

        <h2>üîë MediaID copy nhanh</h2>
        <div class="input-group">
          <label>MediaID (generationId) v·ª´a gen</label>
          <textarea id="mediaIdOutput" readonly placeholder="Sau khi b·∫Øn test, mediaID s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y ƒë·ªÉ copy sang index3 (MediaID Input / Veo3)."></textarea>
        </div>
      </div>

      <!-- RIGHT: K·∫æT QU·∫¢ + LOG -->
      <div class="card">
        <h2>üìä K·∫øt qu·∫£ ·∫£nh + mediaID</h2>
        <div id="results" class="results-grid"></div>

        <h2 style="margin-top:14px;">üßæ Log</h2>
        <div id="log" class="log"></div>
      </div>
    </div>
  </div>

  <script>
    let tokenListCache = [];

    function appendLog(message, type = 'info') {
      const logEl = document.getElementById('log');
      const line = document.createElement('div');
      line.className = 'log-line ' + type;
      const ts = new Date().toLocaleTimeString();
      line.textContent = '[' + ts + '] ' + message;
      logEl.appendChild(line);
      logEl.scrollTop = logEl.scrollHeight;
    }

    async function refreshTokenList() {
      try {
        const res = await fetch('/api/list-tokens');
        const data = await res.json();
        const listEl = document.getElementById('tokenList');
        const statusEl = document.getElementById('tokenPoolStatus');

        listEl.innerHTML = '';

        if (!data.success || !data.tokens || data.tokens.length === 0) {
          listEl.innerHTML = '<div style="font-size:0.8rem;color:#6b7280;">Ch∆∞a c√≥ token n√†o trong tokens.txt.</div>';
          statusEl.textContent = '0 token.';
          tokenListCache = [];
          appendLog('Kh√¥ng t√¨m th·∫•y token n√†o trong tokens.txt', 'warn');
          return;
        }

        tokenListCache = data.tokens;
        statusEl.textContent = `T√¨m th·∫•y ${data.tokens.length} token.`;

        data.tokens.forEach(t => {
          const row = document.createElement('div');
          row.className = 'token-item';
          const proxyLabel = t.hasProxy ? 'üåê proxy' : 'üè† local';
          row.innerHTML = `
            <label>
              <input type="checkbox" class="token-checkbox" value="${t.name}">
              <span>${t.name}</span>
            </label>
            <span class="token-proxy-tag">${proxyLabel}</span>
          `;
          listEl.appendChild(row);
        });

        appendLog(`ƒê√£ load ${data.tokens.length} token t·ª´ tokens.txt`, 'info');
      } catch (err) {
        appendLog('L·ªói load token list: ' + err.message, 'error');
      }
    }

    async function loadTokenPool() {
      const checkboxes = document.querySelectorAll('.token-checkbox:checked');
      const names = Array.from(checkboxes).map(c => c.value);
      const statusEl = document.getElementById('tokenPoolStatus');

      if (names.length === 0) {
        alert('Ch·ªçn √≠t nh·∫•t 1 token ƒë·ªÉ t·∫°o pool.');
        return;
      }

      appendLog(`Load token pool: ${names.join(', ')}`, 'info');
      statusEl.textContent = 'ƒêang load pool...';

      try {
        const res = await fetch('/api/load-token-pool', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ tokenNames: names })
        });
        const data = await res.json();
        if (data.success) {
          statusEl.textContent = `‚úÖ Pool: ${data.tokens.join(', ')}`;
          appendLog(`Token pool ready v·ªõi ${data.tokens.length} token`, 'success');
        } else {
          statusEl.textContent = 'L·ªói load pool';
          appendLog('L·ªói load token pool: ' + data.error, 'error');
        }
      } catch (err) {
        statusEl.textContent = 'L·ªói load pool';
        appendLog('L·ªói load token pool: ' + err.message, 'error');
      }
    }

    function parseTestPrompts() {
      const raw = document.getElementById('testPrompts').value.trim();
      if (!raw) return [];
      return raw.split('\n')
        .map(l => l.trim())
        .filter(Boolean)
        .map(line => line.replace(/^\d+\.\s*/, '').replace(/^#\d+[:.]\s*/i, ''));
    }

    async function runBurstTest() {
      const prompts = parseTestPrompts();
      const common = document.getElementById('testCommon').value.trim();
      const aspect = document.getElementById('testAspect').value;
      const burstStatus = document.getElementById('burstStatus');
      const resultsEl = document.getElementById('results');
      const mediaOut = document.getElementById('mediaIdOutput');

      if (prompts.length === 0) {
        alert('Nh·∫≠p √≠t nh·∫•t 1 prompt ƒë·ªÉ test.');
        return;
      }

      resultsEl.innerHTML = '';
      mediaOut.value = '';
      burstStatus.textContent = `ƒêang gen ${prompts.length} ·∫£nh...`;
      appendLog(`B·∫Øt ƒë·∫ßu burst test v·ªõi ${prompts.length} prompt`, 'info');

      const allMediaIds = [];

      for (let i = 0; i < prompts.length; i++) {
        let p = prompts[i];
        if (common) p = p + '. ' + common;

        appendLog(`[#${i + 1}] G·ª≠i /api/generate`, 'info');
        try {
          const res = await fetch('/api/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt: p, aspectRatio: aspect })
          });
          const data = await res.json();
          if (data.success) {
            const mediaId = data.generationId || '(no generationId)';
            allMediaIds.push(mediaId);

            const card = document.createElement('div');
            card.className = 'result-item';
            card.innerHTML = `
              <img src="${data.imageUrl}" alt="Image ${i + 1}">
              <div class="result-body">
                <div class="idx">·∫¢nh ${i + 1}</div>
                <div style="font-size:0.75rem;color:#4b5563;margin-bottom:2px;">MediaID:</div>
                <div style="font-size:0.7rem;word-break:break-all;">${mediaId}</div>
              </div>
            `;
            resultsEl.appendChild(card);

            appendLog(`[#${i + 1}] OK, mediaID = ${mediaId.substring(0, 24)}...`, 'success');
          } else {
            appendLog(`[#${i + 1}] L·ªói gen ·∫£nh: ${data.error || 'Unknown'}`, 'error');
          }
        } catch (err) {
          appendLog(`[#${i + 1}] L·ªói fetch /api/generate: ${err.message}`, 'error');
        }
      }

      if (allMediaIds.length > 0) {
        mediaOut.value = allMediaIds.join('\n');
        burstStatus.textContent = `Ho√†n th√†nh: ${allMediaIds.length}/${prompts.length} ·∫£nh c√≥ mediaID. Copy kh·ªëi tr√™n ƒë·ªÉ d√πng ·ªü index3 (MediaID Input).`;
      } else {
        burstStatus.textContent = 'Kh√¥ng gen ƒë∆∞·ª£c ·∫£nh n√†o th√†nh c√¥ng.';
      }
    }

    // Init
    (async function init() {
      appendLog('Kh·ªüi ƒë·ªông trang Index 4 (multi acc + proxy test)...', 'info');
      await refreshTokenList();
      try {
        const res = await fetch('/api/token-pool-status');
        const data = await res.json();
        if (data.success && data.poolSize > 0) {
          document.getElementById('tokenPoolStatus').textContent = `ƒê√£ c√≥ pool s·∫µn: ${data.tokens.join(', ')}`;
          appendLog(`Server ƒëang c√≥ token pool s·∫µn (${data.poolSize} token)`, 'info');
        }
      } catch (_) {}
    })();
  </script>
</body>
</html>
